{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-bold">Pending Uploads</h1>
      <div class="flex gap-2">
        <a href="{% url 'admin_panel' %}" class="btn">‚Üê Back to Dashboard</a>
      </div>
    </div>

    {% if images %}
    <!-- Bulk Actions -->
    <div class="glass p-6 rounded-lg mb-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <label class="flex items-center">
            <input type="checkbox" id="select-all" class="form-checkbox mr-2">
            <span>Select All</span>
          </label>
          <span id="selected-count" class="text-sm opacity-75">0 selected</span>
        </div>
        <div class="flex gap-2">
          <button id="bulk-approve" class="btn bg-green-500/20 text-green-300 hover:bg-green-500/30" disabled>
            Approve Selected
          </button>
          <button id="bulk-reject" class="btn bg-red-500/20 text-red-300 hover:bg-red-500/30" disabled>
            Delete Selected
          </button>
        </div>
      </div>
    </div>

    <!-- Images Grid -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
      {% for image in images %}
      <div class="relative group">
        <label class="block relative cursor-pointer">
          <input type="checkbox" class="image-checkbox absolute top-2 left-2 z-10 form-checkbox" 
                 data-image-id="{{ image.pk }}">
          <div class="relative">
            <img src="{{ image.file.url }}" alt="{{ image.description|truncatechars:50 }}" 
                 class="w-full h-48 object-cover rounded-lg">
            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all rounded-lg"></div>
            
            <!-- Image Info Overlay -->
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3 rounded-b-lg">
              <div class="text-xs space-y-1">
                <div class="font-medium truncate">by {{ image.uploader.username }}</div>
                <div class="opacity-75">{{ image.uploaded_at|date:"M d" }}</div>
                {% if image.characters.exists %}
                <div class="opacity-75 truncate">
                  {% for char in image.characters.all %}{{ char.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <div class="flex flex-col gap-1">
                <form method="post" action="{% url 'admin_approve_image' image.pk %}" class="inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="approve">
                  <input type="hidden" name="next" value="admin_pending_uploads">
                  <button type="submit" class="bg-green-500/80 hover:bg-green-500 text-white p-1 rounded text-xs">
                    ‚úì
                  </button>
                </form>
                <form method="post" action="{% url 'admin_approve_image' image.pk %}" 
                      onsubmit="return confirm('Delete this image?')" class="inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="reject">
                  <input type="hidden" name="next" value="admin_pending_uploads">
                  <button type="submit" class="bg-red-500/80 hover:bg-red-500 text-white p-1 rounded text-xs">
                    ‚úó
                  </button>
                </form>
                <a href="{% url 'image_detail' image.pk %}" 
                   class="bg-blue-500/80 hover:bg-blue-500 text-white p-1 rounded text-xs text-center">
                  üëÅ
                </a>
              </div>
            </div>
          </div>
        </label>
      </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="mt-8 flex items-center justify-center gap-2">
      {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="btn">Previous</a>
      {% endif %}
      <span class="px-4 py-2">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </span>
      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="btn">Next</a>
      {% endif %}
    </div>
    {% endif %}

    <!-- Bulk Action Form -->
    <form id="bulk-form" method="post" class="hidden">
      {% csrf_token %}
      <input type="hidden" name="action" id="bulk-action">
      <input type="hidden" name="image_ids" id="bulk-image-ids">
    </form>

    {% else %}
    <!-- No Pending Images -->
    <div class="glass p-12 rounded-lg text-center">
      <div class="text-6xl mb-4">üéâ</div>
      <h2 class="text-xl font-semibold mb-2">All caught up!</h2>
      <p class="opacity-75">No pending uploads to review.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAll = document.getElementById('select-all');
  const imageCheckboxes = document.querySelectorAll('.image-checkbox');
  const selectedCount = document.getElementById('selected-count');
  const bulkApprove = document.getElementById('bulk-approve');
  const bulkReject = document.getElementById('bulk-reject');
  const bulkForm = document.getElementById('bulk-form');

  function updateBulkActions() {
    const selected = Array.from(imageCheckboxes).filter(cb => cb.checked);
    const count = selected.length;
    
    selectedCount.textContent = `${count} selected`;
    bulkApprove.disabled = count === 0;
    bulkReject.disabled = count === 0;
    
    selectAll.indeterminate = count > 0 && count < imageCheckboxes.length;
    selectAll.checked = count === imageCheckboxes.length;
  }

  selectAll.addEventListener('change', function() {
    imageCheckboxes.forEach(cb => cb.checked = this.checked);
    updateBulkActions();
  });

  imageCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateBulkActions);
  });

  function performBulkAction(action) {
    const selected = Array.from(imageCheckboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.dataset.imageId);
    
    if (selected.length === 0) return;
    
    if (action === 'reject') {
      if (!confirm(`Are you sure you want to delete ${selected.length} image(s)?`)) {
        return;
      }
    }
    
    document.getElementById('bulk-action').value = action;
    document.getElementById('bulk-image-ids').value = selected.join(',');
    bulkForm.submit();
  }

  bulkApprove.addEventListener('click', () => performBulkAction('approve'));
  bulkReject.addEventListener('click', () => performBulkAction('reject'));

  updateBulkActions();
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.form-checkbox {
  @apply w-4 h-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500 focus:ring-2;
}
</style>
{% endblock %}
